#!/bin/bash

# Parse the compact output generated by omnetpp when the
# option 'cmdenv-performance-display = false' is present
# in the omnetpp.ini file

set -e

# Get the simulation root
PWD=$(pwd) # save the current directory in order to get back later
cd -P "$( dirname "${BASH_SOURCE[0]}" )/../"
# Enter the logs directory
cd run/run_logs

for INPUT_FILE in *.out.log
do
	# Input file named Experiment_Run.out.log
    echo "Processing file $INPUT_FILE"
    OUTPUT_FILE="${INPUT_FILE%%.*}.csv"
    
    EXPERIMENT="${INPUT_FILE%%_*}" # get experiment
    REST="${INPUT_FILE##*_}" # get everything after the experiment name
	
    RUN="${REST%%.*}" # get the run number
    # Generate a csv file from the log
    echo '"Event Number","Simulated Time","Elapsed Time","Events per Second","Experiment","Run"' > $OUTPUT_FILE
    # this command applies consecutive substitutions to the output text (sample below)
    # ** Event #1622183424   T=1754.33044188773   Elapsed: 1838.679s (30m 38s)  2% completed   ev/sec=879488
	# add two more columns: "Experiment",Run 
    sed --quiet '/Elapsed/{s/^.*#//; s/\s*T=/,/; s/ .*: /,/; s/s .*=/,/; s/$/,"'"$EXPERIMENT"'",'"$RUN"'/p}' $INPUT_FILE >> $OUTPUT_FILE
done

cd $PWD

exit 0
